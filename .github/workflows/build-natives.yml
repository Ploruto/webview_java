name: Build Native Libraries

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'native/**'
      - '.github/workflows/build-natives.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual trigger

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            pkg-config

      - name: Clone webview
        run: |
          git clone --depth 1 --branch 0.12.0 https://github.com/webview/webview.git /tmp/webview

      - name: Build Linux x86_64
        run: |
          OUTPUT_DIR="core/src/main/resources/dev/webview/natives/x86_64-linux"
          mkdir -p "$OUTPUT_DIR"
          
          # Build webview shared library directly using its CMakeLists.txt
          cd /tmp/webview
          cmake -G Ninja -B build -S . \
            -D CMAKE_BUILD_TYPE=Release \
            -D WEBVIEW_BUILD_SHARED_LIBRARY=ON \
            -D WEBVIEW_BUILD_STATIC_LIBRARY=OFF \
            -D WEBVIEW_BUILD_EXAMPLES=OFF
          cmake --build build
          
          # Copy to Java resources
          cp build/webview/libwebview.so "$GITHUB_WORKSPACE/$OUTPUT_DIR/"
          
          echo "✓ Linux x86_64 built"
          nm -D "$GITHUB_WORKSPACE/$OUTPUT_DIR/libwebview.so" | grep webview_create && echo "✓ webview_create symbol found" || echo "⚠️ Warning: webview_create symbol not found"
          ls -lh "$GITHUB_WORKSPACE/$OUTPUT_DIR"

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: natives-linux
          path: core/src/main/resources/dev/webview/natives/x86_64-linux/
          retention-days: 7

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Clone webview
        run: |
          git clone --depth 1 --branch 0.12.0 https://github.com/webview/webview.git /tmp/webview

      - name: Build macOS ${{ matrix.arch }}
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            OUTPUT_DIR="core/src/main/resources/dev/webview/natives/aarch64-macos"
          else
            OUTPUT_DIR="core/src/main/resources/dev/webview/natives/x86_64-macos"
          fi
          mkdir -p "$OUTPUT_DIR"
          
          # Build webview shared library directly using its CMakeLists.txt
          cd /tmp/webview
          cmake -G Ninja -B build -S . \
            -D CMAKE_BUILD_TYPE=Release \
            -D CMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -D WEBVIEW_BUILD_SHARED_LIBRARY=ON \
            -D WEBVIEW_BUILD_STATIC_LIBRARY=OFF \
            -D WEBVIEW_BUILD_EXAMPLES=OFF
          cmake --build build
          
          # Copy to Java resources
          cp build/webview/libwebview.dylib "$GITHUB_WORKSPACE/$OUTPUT_DIR/"
          
          echo "✓ macOS ${{ matrix.arch }} built"
          nm "$GITHUB_WORKSPACE/$OUTPUT_DIR/libwebview.dylib" | grep webview_create && echo "✓ webview_create symbol found" || echo "⚠️ Warning: webview_create symbol not found"
          ls -lh "$GITHUB_WORKSPACE/$OUTPUT_DIR"
          file "$GITHUB_WORKSPACE/$OUTPUT_DIR/libwebview.dylib"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: natives-macos-${{ matrix.arch }}
          path: core/src/main/resources/dev/webview/natives/*/
          retention-days: 7

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Clone webview
        shell: bash
        run: |
          git clone --depth 1 --branch 0.12.0 https://github.com/webview/webview.git C:/webview

      - name: Install NuGet WebView2
        shell: powershell
        run: |
          nuget install Microsoft.Web.WebView2 -Version 1.0.2792.45 -OutputDirectory C:/webview2

      - name: Build Windows x86_64
        shell: bash
        run: |
          OUTPUT_DIR="core/src/main/resources/dev/webview/natives/x86_64-windows"
          mkdir -p "$OUTPUT_DIR"
          
          # Build webview shared library directly using its CMakeLists.txt
          cd C:/webview
          cmake -G "Ninja" -B build -S . \
            -D CMAKE_BUILD_TYPE=Release \
            -D WEBVIEW_BUILD_SHARED_LIBRARY=ON \
            -D WEBVIEW_BUILD_STATIC_LIBRARY=OFF \
            -D WEBVIEW_BUILD_EXAMPLES=OFF
          cmake --build build
          
          # Copy to Java resources
          cp build/webview/webview.dll "$GITHUB_WORKSPACE/$OUTPUT_DIR/"
          
          echo "✓ Windows x86_64 built"
          ls -lh "$GITHUB_WORKSPACE/$OUTPUT_DIR/"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: natives-windows
          path: core/src/main/resources/dev/webview/natives/x86_64-windows/
          retention-days: 7

  commit-binaries:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Copy binaries to resources
        run: |
          mkdir -p core/src/main/resources/dev/webview/natives/x86_64-linux
          mkdir -p core/src/main/resources/dev/webview/natives/x86_64-macos
          mkdir -p core/src/main/resources/dev/webview/natives/aarch64-macos
          mkdir -p core/src/main/resources/dev/webview/natives/x86_64-windows
          
          # Copy Linux
          if [ -d "artifacts/natives-linux" ]; then
            cp -v artifacts/natives-linux/* core/src/main/resources/dev/webview/natives/x86_64-linux/ || true
          fi
          
          # Copy macOS x86_64
          if [ -d "artifacts/natives-macos-x86_64" ]; then
            find artifacts/natives-macos-x86_64 -name "*.dylib" -exec cp -v {} core/src/main/resources/dev/webview/natives/x86_64-macos/ \; || true
          fi
          
          # Copy macOS ARM64
          if [ -d "artifacts/natives-macos-arm64" ]; then
            find artifacts/natives-macos-arm64 -name "*.dylib" -exec cp -v {} core/src/main/resources/dev/webview/natives/aarch64-macos/ \; || true
          fi
          
          # Copy Windows
          if [ -d "artifacts/natives-windows" ]; then
            cp -v artifacts/natives-windows/* core/src/main/resources/dev/webview/natives/x86_64-windows/ || true
          fi
          
          echo "=== Binary inventory ==="
          find core/src/main/resources/dev/webview/natives -type f -ls

      - name: Commit and push binaries
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add core/src/main/resources/dev/webview/natives/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update native libraries [skip ci]"
            git push
          fi
