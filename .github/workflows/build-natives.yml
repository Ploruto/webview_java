name: Build Native Libraries

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'native/**'
      - '.github/workflows/build-natives.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual trigger

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            pkg-config

      - name: Clone webview
        run: |
          git clone --depth 1 --branch 0.12.0 https://github.com/webview/webview.git /tmp/webview

      - name: Build Linux x86_64
        run: |
          cd native
          mkdir -p build
          OUTPUT_DIR="../core/src/main/resources/dev/webview/natives/x86_64-linux"
          mkdir -p "$OUTPUT_DIR"
          
          # Get GTK/WebKit flags
          GTK_CFLAGS=$(pkg-config --cflags gtk+-3.0 webkit2gtk-4.1)
          GTK_LIBS=$(pkg-config --libs gtk+-3.0 webkit2gtk-4.1)
          
          # Build shared library with full symbol preservation
          g++ -std=c++11 -fPIC -shared \
            -I/tmp/webview/core/include \
            $GTK_CFLAGS \
            -Wl,--export-dynamic \
            -Wl,-Bsymbolic \
            -o "$OUTPUT_DIR/libwebview.so" \
            webview_wrapper.cc \
            $GTK_LIBS -ldl
          
          echo "✓ Linux x86_64 built"
          nm -D "$OUTPUT_DIR/libwebview.so" | grep webview_create || echo "⚠️ Warning: webview_create symbol not found"
          ls -lh "$OUTPUT_DIR"

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: natives-linux
          path: core/src/main/resources/dev/webview/natives/x86_64-linux/
          retention-days: 7

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Clone webview
        run: |
          git clone --depth 1 --branch 0.12.0 https://github.com/webview/webview.git /tmp/webview

      - name: Build macOS ${{ matrix.arch }}
        run: |
          cd native
          mkdir -p build
          
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            OUTPUT_DIR="../core/src/main/resources/dev/webview/natives/aarch64-macos"
          else
            OUTPUT_DIR="../core/src/main/resources/dev/webview/natives/x86_64-macos"
          fi
          mkdir -p "$OUTPUT_DIR"
          
          # Build with specific architecture and full symbol preservation
          clang++ -std=c++11 -fPIC -shared \
            -arch ${{ matrix.arch }} \
            -fvisibility=default \
            -I/tmp/webview/core/include \
            -framework Cocoa \
            -framework WebKit \
            -o "$OUTPUT_DIR/libwebview.dylib" \
            webview_wrapper.cc
          
          echo "✓ macOS ${{ matrix.arch }} built"
          nm "$OUTPUT_DIR/libwebview.dylib" | grep webview_create || echo "⚠️ Warning: webview_create symbol not found"
          ls -lh "$OUTPUT_DIR"
          file "$OUTPUT_DIR/libwebview.dylib"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: natives-macos-${{ matrix.arch }}
          path: core/src/main/resources/dev/webview/natives/*/
          retention-days: 7

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Clone webview
        shell: bash
        run: |
          git clone --depth 1 --branch 0.12.0 https://github.com/webview/webview.git C:/webview

      - name: Install NuGet WebView2
        shell: powershell
        run: |
          nuget install Microsoft.Web.WebView2 -Version 1.0.2792.45 -OutputDirectory C:/webview2

      - name: Build Windows x86_64
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          cd native
          if not exist build mkdir build
          if not exist ..\core\src\main\resources\dev\webview\natives\x86_64-windows mkdir ..\core\src\main\resources\dev\webview\natives\x86_64-windows
          
          cl /EHsc /std:c++14 /D_WINDOWS /DWEBVIEW_STATIC ^
            /IC:\webview\core\include ^
            /IC:\webview2\Microsoft.Web.WebView2.1.0.2792.45\build\native\include ^
            /LD webview_wrapper.cc ^
            /link /DEF:webview.def /OUT:..\core\src\main\resources\dev\webview\natives\x86_64-windows\webview.dll ^
            /DEBUG ^
            advapi32.lib ole32.lib shell32.lib shlwapi.lib user32.lib version.lib ^
            C:\webview2\Microsoft.Web.WebView2.1.0.2792.45\build\native\x64\WebView2LoaderStatic.lib
          
          if exist ..\core\src\main\resources\dev\webview\natives\x86_64-windows\webview.dll (
            echo Windows x86_64 built successfully
          ) else (
            echo ERROR: Build failed - DLL not created
            exit /b 1
          )
          dir ..\core\src\main\resources\dev\webview\natives\x86_64-windows

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: natives-windows
          path: core/src/main/resources/dev/webview/natives/x86_64-windows/
          retention-days: 7

  commit-binaries:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Copy binaries to resources
        run: |
          mkdir -p core/src/main/resources/dev/webview/natives/x86_64-linux
          mkdir -p core/src/main/resources/dev/webview/natives/x86_64-macos
          mkdir -p core/src/main/resources/dev/webview/natives/aarch64-macos
          mkdir -p core/src/main/resources/dev/webview/natives/x86_64-windows
          
          # Copy Linux
          if [ -d "artifacts/natives-linux" ]; then
            cp -v artifacts/natives-linux/* core/src/main/resources/dev/webview/natives/x86_64-linux/ || true
          fi
          
          # Copy macOS x86_64
          if [ -d "artifacts/natives-macos-x86_64" ]; then
            find artifacts/natives-macos-x86_64 -name "*.dylib" -exec cp -v {} core/src/main/resources/dev/webview/natives/x86_64-macos/ \; || true
          fi
          
          # Copy macOS ARM64
          if [ -d "artifacts/natives-macos-arm64" ]; then
            find artifacts/natives-macos-arm64 -name "*.dylib" -exec cp -v {} core/src/main/resources/dev/webview/natives/aarch64-macos/ \; || true
          fi
          
          # Copy Windows
          if [ -d "artifacts/natives-windows" ]; then
            cp -v artifacts/natives-windows/* core/src/main/resources/dev/webview/natives/x86_64-windows/ || true
          fi
          
          echo "=== Binary inventory ==="
          find core/src/main/resources/dev/webview/natives -type f -ls

      - name: Commit and push binaries
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add core/src/main/resources/dev/webview/natives/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update native libraries [skip ci]"
            git push
          fi
